---
title: "mexico_rasters"
author: "Carmen Galaz-Garc√≠a"
date: "5/28/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(raster) ### NOTE: attach this BEFORE tidyverse
library(tidyverse)
library(here)
library(sf)
library(fasterize)
library(patchwork)
```


I generated the raster file *mexico_median.tif* using [Google Earth Engine](https://earthengine.google.com). 
This raster shows the median of the images in the USGS Landsat 8 Collection 1 (Tier 1 TOA Reflectance) from May 1st 2013 to May 1st 2014. 
To read more on how how I used Google Earth Engine to create this raster file, check out my other blog post on this topic!


# Raster exploration

The Landsat 8 raster I produced using the 


```{r, include=FALSE}
# --- Reading individual layers
landsat_file <- here('mexico_median.tif')

red <- raster(landsat_file, band = 1) # B4 band = red
green <- raster(landsat_file, band = 2) # B3 band = green
blue <- raster(landsat_file, band = 3) # B2 band = blue
```


```{r, out.width = "50%", out.height = "50%"}
# -----  EXPLORING RGB LAYERS -----
mex_rgb <- raster::stack(here('mexico_median.tif')) # read all bands as raster stack
#mex_rgb
# looking at stack information we get that:
#   B4 band = red
#   B3 band = green
#   B2 band = blue

# ---- Define Plot Function ----
color_graph <- function(band,color){
  return (plot(band, 
               col = hcl.colors(n = 100, palette = color),
               axes = FALSE,
               legend = FALSE)
          )
}
# --- Colors
RGB = c('Reds 2', 'Greens 2', 'Blues 2')

# --- plot RGB bands
for (i in 1:3){
  color_graph(mex_rgb[[i]],RGB[i])
}
```

# Masking

To do the masking and select only the region corresponding to Mexico I used a polygon shapefile made by Hijmans, Robert J. from the Museum of Vertebrate Zoology at UC Berkeley. To use the polygon shapefile for masking we need to convert it into a raster.

```{r}
# --- read shapefile
mex_sf <- read_sf(here('stanford-zc863pb5331-shapefile/zc863pb5331.shp')) %>%
  st_transform(crs(mex_rgb))   # match CRS

# --- transform shapefile into raster using red band as guide
mex_rast <- fasterize::fasterize(mex_sf, mex_rgb[[1]])
plot(mex_rast,axes=FALSE, box=FALSE)
#writeRaster(mex_rast, 'data/county.tif') #export mask raster
```

```{r}
# --- mask each layer
for (i in 1:3){
  mex_rgb[[i]] <- mask(mex_rgb[[i]],mex_rast)
}

# --- plot masked RGB bands
for (i in 1:3){
  color_graph(mex_rgb[[i]],RGB[i])
}

```

# True Color

```{r}
red <- mask(red, mex_rast)*255
blue <- mask(blue, mex_rast)*255
green <- mask(green,mex_rast)*255


masked_mex <- raster::stack(red,blue,green)
plotRGB(masked_mex, scale=160, colNA='skyblue1')
```

# Citation
https://geodata.lib.berkeley.edu/catalog/stanford-zc863pb5331

https://developers.google.com/earth-engine/datasets/catalog/LANDSAT_LC08_C01_T1_TOA
